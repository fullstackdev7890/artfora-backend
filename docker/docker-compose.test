version: '3'

services:
  api:
      image: ${short_branch}-${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}
      container_name: tse-api
      working_dir: /app
      ports:
          - 80
          - 443
      links:
        - pgsql
        - pgsql_test
      environment:
          REDIS_PORT: "6379"
          XDEBUG_START_WITH_REQUEST: "yes"
          XDEBUG_CLIENT_PORT: 9000
          XDEBUG_CLIENT_HOST: host.docker.internal
      networks:
        - escort

  pgsql:
    image: postgres:15rc2
    container_name: tse-pgsql
    ports:
      - 5432
    environment:
      POSTGRES_PASSWORD: "pgpassword"
      POSTGRES_USER: pguser
      POSTGRES_DB: pgdb
    volumes:
      - .:/app
    networks:
      - escort

  pgsql_test:
    image: postgres:15rc2
    container_name: tse-pgsql-test
    ports:
        - 5432
    environment:
      POSTGRES_PASSWORD: "pgpassword"
      POSTGRES_USER: pguser
      POSTGRES_DB: pgdb
    volumes:
    - .:/app
    command: ["-c", "fsync=off"]
    networks:
      - escort

  redis:
    image: redis:4
    container_name: tse-redis
    ports:
      - 6379
    networks:
      - escort

networks:
  escort:
    external: true
